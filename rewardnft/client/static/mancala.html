<!-- Need to add a whole section for the NFTs to select keys. Basically should be able to click on a key to start a match maybe? Maybe a list of recent match requests too -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mancala - Organic Themed</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #faf3e0;
            color: #333;
            margin: 0;
            padding: 0;
            text-align: center;
        }

        h1 {
            margin-top: 20px;
            color: #8b5e34;
            font-size: 2.5em;
        }

        .game-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin: 50px auto;
            width: 90%;
        }

        .key-container {
            background-color: #e0d8c3;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            margin-right: 20px;
            flex: 1;
            max-width: 300px;
            overflow-y: auto;
            height: 100%;
        }

		.key-scrollable {
			overflow-y: auto;
			max-height: 500px;
		}

        .key {
            background-color: #f7f3e9;
            border: 2px solid #8b5e34;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            text-align: left;
            color: #52382b;
            font-weight: bold;
        }

        .key:hover {
            background-color: #b08a63;
            color: #fff;
        }

		.key-disabled {
			background-color: #ccc;
			color: #999;
			cursor: not-allowed;
            border: 2px solid #8b5e34;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            color: #55585C;
            font-weight: bold;
		}

        .board-container {
            flex: 2;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            background-color: #e0d8c3;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.2);
        }

        .board {
            display: grid;
            grid-template-columns: repeat(8, 110px);
            grid-gap: 50px;
        }

        .pit, .store {
            width: 110px;
            height: 110px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f7f3e9;
            border: 3px solid #8b5e34;
            border-radius: 50%;
            font-size: 1.8em;
            color: #52382b;
            font-weight: bold;
            position: relative;
        }

        .store {
            grid-row: span 2;
            background-color: #8b5e34;
            color: #f7f3e9;
            border-radius: 100px;
            width: 130px;
            height: 230px;
        }

        .pit:hover {
            background-color: #b08a63;
            color: #fff;
            cursor: pointer;
        }

        .disabled {
            background-color: #ccc;
            color: #999;
            cursor: not-allowed;
        }

        .store-title {
            position: absolute;
            top: -80px;
            font-size: 0.8em;
            color: #333;
        }

        #message {
            font-size: 1.5em;
            margin-top: 20px;
            color: #6b4f2b;
        }

        footer {
            margin-top: 50px;
            font-size: 0.8em;
            color: #7b5d46;
        }
		.modal {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background-color: #e0d8c3;
			border: 2px solid #8b5e34;
			border-radius: 10px;
			box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
			padding: 20px;
			text-align: center;
			z-index: 1000;
		}
		.modal-content {
			margin: 10px 0;
		}

		.modal button {
			margin: 5px;
			padding: 10px 20px;
			background-color: #8b5e34;
			color: #fff;
			border: none;
			border-radius: 5px;
			cursor: pointer;
		}

		.modal button:hover {
			background-color: #b08a63;
		}
    </style>
</head>
<body>
    <h1>Mancala - Desert Wisdom</h1>

    <div class="game-container">
        <div class="key-container">
            <h2>Available Keys</h2>
			<div id="keyContainer" class = "key-scrollable"></div>
        </div>

        <div class="board-container">
            <div class="board" id="mancalaBoard">
                <!-- Player B's pits and store -->
                <div class="store" id="storeB">
                    <div class="store-title">Player B's Store</div>
                    0
                </div>
                <div class="pit" id="pit12" onclick="makeMove(12)">4</div>
                <div class="pit" id="pit11" onclick="makeMove(11)">4</div>
                <div class="pit" id="pit10" onclick="makeMove(10)">4</div>
                <div class="pit" id="pit9" onclick="makeMove(9)">4</div>
                <div class="pit" id="pit8" onclick="makeMove(8)">4</div>
                <div class="pit" id="pit7" onclick="makeMove(7)">4</div>

                <!-- Empty placeholder for symmetry -->
                <div></div>

                <!-- Player A's pits and store -->
                <div class="pit" id="pit0" onclick="makeMove(0)">4</div>
                <div class="pit" id="pit1" onclick="makeMove(1)">4</div>
                <div class="pit" id="pit2" onclick="makeMove(2)">4</div>
                <div class="pit" id="pit3" onclick="makeMove(3)">4</div>
                <div class="pit" id="pit4" onclick="makeMove(4)">4</div>
                <div class="pit" id="pit5" onclick="makeMove(5)">4</div>
                <div class="store" id="storeA">
                    <div class="store-title">Player A's Store</div>
                    0
                </div>
            </div>
        </div>
    </div>
	<div id="keyActionModal" class="modal" style="display: none;">
		<div class="modal-content">
			<h3>Select Action</h3>
			<p>Do you want to start a new match or accept an existing one?</p>
			<button onclick="chooseAction('new')">Start New Match</button>
			<button onclick="chooseAction('existing')">Accept Existing Match</button>
			<button onclick="closeModal()">Cancel</button>
		</div>
	</div>
	<!-- Modal for selecting a match request-->
	<div id="matchRequestModal" class="modal" style="display: none;">
		<div class="modal-content">
			<h3>Match Request</h3>
			<div id="matchRequestList" class = "match-scrollable"></div>
			<button onclick="acceptMatch()">Accept</button>
			<button onclick="rejectMatch()">Reject</button>
		</div>
	</div>
    <div id="message">Connecting...</div>

    <footer>
        &copy; 2024 Mancala by the Sands | Arcadium
    </footer>

    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.5.2/dist/web3.min.js"></script>
    <script>
        let mancalaContractAddress = "0xb737f5Da67f96E0232B7aE36D3E8eac6662fB5D3";
		let keyContractAddress = "0x8946EE31706d064DEe3Ed3E3afd779B1b337E82A";
		let keyDataManagerContractAddress = "0x6006313EcAD73d92C28e12549E5e98304Ef1d0E1";

        let mancalaABI = [
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_keyContract",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "_minKeyHealth",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "_minKeyAge",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "_minKeyClaims",
						"type": "uint256"
					}
				],
				"stateMutability": "nonpayable",
				"type": "constructor"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					},
					{
						"indexed": false,
						"internalType": "address",
						"name": "winner",
						"type": "address"
					}
				],
				"name": "GameEnded",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					},
					{
						"indexed": false,
						"internalType": "address",
						"name": "playerA",
						"type": "address"
					},
					{
						"indexed": false,
						"internalType": "address",
						"name": "playerB",
						"type": "address"
					}
				],
				"name": "GameStarted",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					},
					{
						"indexed": false,
						"internalType": "address",
						"name": "playerA",
						"type": "address"
					},
					{
						"indexed": false,
						"internalType": "address",
						"name": "playerB",
						"type": "address"
					}
				],
				"name": "MatchRequested",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					},
					{
						"indexed": false,
						"internalType": "address",
						"name": "player",
						"type": "address"
					},
					{
						"indexed": false,
						"internalType": "uint8",
						"name": "pitIndex",
						"type": "uint8"
					}
				],
				"name": "MoveMade",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "cancelledBy",
						"type": "address"
					}
				],
				"name": "NominationCancelled",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "OwnerNominated",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "previousOwner",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "OwnershipTransferred",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					},
					{
						"indexed": false,
						"internalType": "address",
						"name": "currentPlayer",
						"type": "address"
					}
				],
				"name": "TurnChanged",
				"type": "event"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "keyId",
						"type": "uint256"
					}
				],
				"name": "acceptMatch",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "acceptOwnership",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					}
				],
				"name": "cancelMatch",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "cancelTransfer",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "changeOwner",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "gameIdCounter",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"name": "games",
				"outputs": [
					{
						"internalType": "address",
						"name": "playerA",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "playerB",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "currentPlayer",
						"type": "address"
					},
					{
						"internalType": "enum MancalaGame.GameState",
						"name": "state",
						"type": "uint8"
					},
					{
						"internalType": "uint256",
						"name": "requestTime",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "keyA",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "keyB",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					}
				],
				"name": "getBoard",
				"outputs": [
					{
						"internalType": "uint8[14]",
						"name": "",
						"type": "uint8[14]"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					}
				],
				"name": "getCurrentPlayer",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					}
				],
				"name": "getGameState",
				"outputs": [
					{
						"internalType": "enum MancalaGame.GameState",
						"name": "",
						"type": "uint8"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					}
				],
				"name": "getPlayers",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "keyContract",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "minKeyAge",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "minKeyClaims",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "minKeyHealth",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					},
					{
						"internalType": "uint8",
						"name": "pitIndex",
						"type": "uint8"
					}
				],
				"name": "moveSeeds",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "nominationDate",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "owner",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "ownerNominee",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					}
				],
				"name": "rejectMatch",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "rejectOwnership",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "opponent",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "keyId",
						"type": "uint256"
					}
				],
				"name": "requestMatch",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "requestTimeout",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_token",
						"type": "address"
					}
				],
				"name": "withdraw",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"stateMutability": "payable",
				"type": "receive"
			}
		]

		let keyABI = [
			{
				"inputs": [],
				"stateMutability": "nonpayable",
				"type": "constructor"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "owner",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "address",
						"name": "approved",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "Approval",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "owner",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "address",
						"name": "operator",
						"type": "address"
					},
					{
						"indexed": false,
						"internalType": "bool",
						"name": "approved",
						"type": "bool"
					}
				],
				"name": "ApprovalForAll",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "minter",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "NFTMinted",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "cancelledBy",
						"type": "address"
					}
				],
				"name": "NominationCancelled",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "OwnerNominated",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "previousOwner",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "OwnershipTransferred",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "from",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "address",
						"name": "to",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "Transfer",
				"type": "event"
			},
			{
				"inputs": [],
				"name": "acceptOwnership",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "to",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "approve",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "owner",
						"type": "address"
					}
				],
				"name": "balanceOf",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "cancelTransfer",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "changeOwner",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "claimManager",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "firstMintDate",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "fundReceiver",
				"outputs": [
					{
						"internalType": "address payable",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "getApproved",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "owner",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "operator",
						"type": "address"
					}
				],
				"name": "isApprovedForAll",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "maxSupply",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_count",
						"type": "uint256"
					}
				],
				"name": "mint",
				"outputs": [],
				"stateMutability": "payable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "mintPrice",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_to",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "_count",
						"type": "uint256"
					}
				],
				"name": "mintTo",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "name",
				"outputs": [
					{
						"internalType": "string",
						"name": "",
						"type": "string"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "nextTokenId",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "nominationDate",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "owner",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "ownerNominee",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "ownerOf",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "paymentToken",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "rejectOwnership",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "from",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "to",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "safeTransferFrom",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "from",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "to",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					},
					{
						"internalType": "bytes",
						"name": "data",
						"type": "bytes"
					}
				],
				"name": "safeTransferFrom",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "operator",
						"type": "address"
					},
					{
						"internalType": "bool",
						"name": "approved",
						"type": "bool"
					}
				],
				"name": "setApprovalForAll",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "string",
						"name": "baseTokenURI",
						"type": "string"
					}
				],
				"name": "setBaseTokenURI",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_claimManager",
						"type": "address"
					}
				],
				"name": "setClaimManager",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address payable",
						"name": "_fundReceiver",
						"type": "address"
					}
				],
				"name": "setFundReceiver",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_maxSupply",
						"type": "uint256"
					}
				],
				"name": "setMaxSupply",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_paymentToken",
						"type": "address"
					}
				],
				"name": "setPaymentToken",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_price",
						"type": "uint256"
					}
				],
				"name": "setPrice",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "bytes4",
						"name": "interfaceId",
						"type": "bytes4"
					}
				],
				"name": "supportsInterface",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "symbol",
				"outputs": [
					{
						"internalType": "string",
						"name": "",
						"type": "string"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "index",
						"type": "uint256"
					}
				],
				"name": "tokenByIndex",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "owner",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "index",
						"type": "uint256"
					}
				],
				"name": "tokenOfOwnerByIndex",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "tokenURI",
				"outputs": [
					{
						"internalType": "string",
						"name": "",
						"type": "string"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "totalSupply",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "from",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "to",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "transferFrom",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_token",
						"type": "address"
					}
				],
				"name": "withdraw",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"stateMutability": "payable",
				"type": "receive"
			}
		];

		let keyDataManagerABI = [
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_nftContract",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "_potionToken",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "_paymentManager",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "_claimerLimit",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "_claimPeriod",
						"type": "uint256"
					},
					{
						"internalType": "uint8",
						"name": "_min_health",
						"type": "uint8"
					}
				],
				"stateMutability": "nonpayable",
				"type": "constructor"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "claimant",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "Claim",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "cancelledBy",
						"type": "address"
					}
				],
				"name": "NominationCancelled",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "OwnerNominated",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "previousOwner",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "OwnershipTransferred",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "owner",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					},
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "qnt",
						"type": "uint256"
					}
				],
				"name": "TokenRepaired",
				"type": "event"
			},
			{
				"inputs": [],
				"name": "acceptOwnership",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "cancelTransfer",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "changeOwner",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "claim",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "claimPeriod",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "index",
						"type": "uint256"
					}
				],
				"name": "claimant",
				"outputs": [
					{
						"components": [
							{
								"internalType": "address",
								"name": "addr",
								"type": "address"
							},
							{
								"internalType": "uint256",
								"name": "tokenId",
								"type": "uint256"
							}
						],
						"internalType": "struct ClaimNFTManager.Claimant",
						"name": "",
						"type": "tuple"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"name": "claimants",
				"outputs": [
					{
						"internalType": "address",
						"name": "addr",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "claimerLimit",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"name": "controllers",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "deleteClaimants",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "getClaimants",
				"outputs": [
					{
						"components": [
							{
								"internalType": "address",
								"name": "addr",
								"type": "address"
							},
							{
								"internalType": "uint256",
								"name": "tokenId",
								"type": "uint256"
							}
						],
						"internalType": "struct ClaimNFTManager.Claimant[]",
						"name": "",
						"type": "tuple[]"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "getClaimantsCount",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "getHealth",
				"outputs": [
					{
						"internalType": "uint8",
						"name": "",
						"type": "uint8"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "getMintDate",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "getTotalClaims",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "hasClaimedInPeriod",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "initializeNFT",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "isClaimReady",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "min_health",
				"outputs": [
					{
						"internalType": "uint8",
						"name": "",
						"type": "uint8"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "nftContract",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "nominationDate",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "owner",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "ownerNominee",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "paymentManager",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "potionToken",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "rejectOwnership",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					},
					{
						"internalType": "uint8",
						"name": "_qnt",
						"type": "uint8"
					}
				],
				"name": "repair",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "resetClaim",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_claimPeriod",
						"type": "uint256"
					}
				],
				"name": "setClaimPeriod",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_claimerLimit",
						"type": "uint256"
					}
				],
				"name": "setClaimerLimit",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint8",
						"name": "_min_health",
						"type": "uint8"
					}
				],
				"name": "setMinHealth",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_nftContract",
						"type": "address"
					}
				],
				"name": "setNFTContract",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_paymentManager",
						"type": "address"
					}
				],
				"name": "setPaymentManager",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_potionToken",
						"type": "address"
					}
				],
				"name": "setPotionToken",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_token",
						"type": "address"
					}
				],
				"name": "withdraw",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"stateMutability": "payable",
				"type": "receive"
			}
		];

		let web3;
        let mancalaContract;
		let keyContract;
		let keyDataManagerContract;
        let gameId;
        let currentPlayer;
        let players;

		let selectedKeyId = null;

		async function selectKey(keyId) {
			let accounts = await web3.eth.getAccounts();
			selectedKeyId = keyId;
			// Check if key is approved to be
			let approved = await keyContract.methods.getApproved(keyId).call();
			if (approved !== mancalaContractAddress) {
				await keyContract.methods.approve(mancalaContractAddress, keyId).send({ from: accounts[0] });
			}
			document.getElementById("keyActionModal").style.display = "block";
		}

		function closeModal() {
			document.getElementById("keyActionModal").style.display = "none";
			selectedKeyId = null;
		}

		function chooseAction(action) {
			if (action === 'new') {
				let opponent = prompt("Enter the opponent's address:");
				if (opponent) {
					startNewMatch(selectedKeyId, opponent);
				} else {
					alert("You must enter an opponent's address to start a new match.");
				}
			} else if (action === 'existing') {
				listMatchRequests(selectedKeyId);
			}
			closeModal();
		}

		async function startNewMatch(tokenId, opponent) {
			let accounts = await web3.eth.getAccounts();
            gameId = await mancalaContract.methods.requestMatch(opponent, tokenId).send({ from: accounts[0] });  
            localStorage.setItem("gameId", gameId);

		}

		// List matches by scanning events for MatchRequested events with the user's address as playerB
		async function listMatchRequests() {
			let accounts = await web3.eth.getAccounts();
			console.log(events);
			// Same but with pagination
			let pageSize = 10;
			let latestBlock = await web3.eth.getBlockNumber();
			let events = [];
			let blockStep = 1000; // Adjust this step size as needed
			let startBlock = latestBlock;
			while (events.length < pageSize && startBlock > 0) {
				let endBlock = Math.max(0, startBlock - blockStep);
				let chunk = await mancalaContract.getPastEvents("MatchRequested", {
					filter: { playerB: accounts[0] },
					fromBlock: endBlock,
					toBlock: startBlock
				});
				events = events.concat(chunk);
				startBlock = endBlock - 1;
			}
			events = events.slice(0, pageSize);
			
			let container = document.getElementById("matchRequestContainer");
			container.innerHTML = "";
			for (let i = 0; i < events.length; i++) {
				let event = events[i];
				let match = document.createElement("div");
				match.classList.add("match-request");
				match.innerHTML = `
					<div>Match request from ${event.returnValues.playerA}</div>
					<button onclick="acceptMatch('${event.returnValues.gameId}')">Accept</button>
				`;
				container.appendChild(match);
			}
			
		}

		async function initialize() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                await window.ethereum.request({ method: "eth_requestAccounts" });
                let accounts = await web3.eth.getAccounts();
                mancalaContract = new web3.eth.Contract(mancalaABI, mancalaContractAddress);
				keyContract = new web3.eth.Contract(keyABI, keyContractAddress);
				keyDataManagerContract = new web3.eth.Contract(keyDataManagerABI, keyDataManagerContractAddress);

                // Get game ID from local storage or pop up that asks for game ID or if they want to start a new game
                gameId = localStorage.getItem("gameId");

                // Fetch the current state of the board and update UI
                updateBoard();
				updateKeys();

                // Listen to events
                mancalaContract.events.MoveMade({}).on("data", event => {
                    updateBoard();
                });

                mancalaContract.events.GameEnded({}).on("data", event => {
                    let winner = event.returnValues.winner;
                    document.getElementById("message").innerText = (winner === "0x0000000000000000000000000000000000000000") ? 
                        "It's a draw!" : `Winner is ${winner}`;
                });
            } else {
                alert("Please install MetaMask to play this game!");
            }
        }

        // Make a move by calling the contract's function
        async function makeMove(pitIndex) {
            let accounts = await web3.eth.getAccounts();
            let player = accounts[0];

            // Only allow current player to make a move
            if (player.toLowerCase() !== currentPlayer.toLowerCase()) {
                document.getElementById("message").innerText = "It's not your turn!";
                return;
            }

            try {
                await mancalaContract.methods.moveSeeds(gameId, pitIndex).send({ from: player });
                document.getElementById("message").innerText = "Move made! Waiting for the next move...";
            } catch (err) {
                console.error(err);
                document.getElementById("message").innerText = "Error making move!";
            }
        }

		// Load NFT keys
		async function updateKeys() {
			// Get the requirements for keys from the mancala contract
			const minHealth = await mancalaContract.methods.minKeyHealth().call();
			const minKeyAge = await mancalaContract.methods.minKeyAge().call();
			const minKeyClaims = await mancalaContract.methods.minKeyClaims().call();

			const accounts = await web3.eth.getAccounts();
			const balance = await keyContract.methods.balanceOf(accounts[0]).call();
			let keys = [];
			// Get container
			let container = document.getElementById("keyContainer");
			for (let i = 0; i < balance; i++) {
				const tokenId = await keyContract.methods.tokenOfOwnerByIndex(accounts[0], i).call();
				// Use the NFT data manager contract to get key details.
				const health = await keyDataManagerContract.methods.getHealth(tokenId).call();
				const mintDate = await keyDataManagerContract.methods.getMintDate(tokenId).call();
				const totalClaims = await keyDataManagerContract.methods.getTotalClaims(tokenId).call();
				const hasClaimedInPeriod = await keyDataManagerContract.methods.hasClaimedInPeriod(tokenId).call();
				// Create key element and add
				let key = document.createElement("div");
				// If the key meets the requirements, add the key class, otherwise key-disabled
				let age = Math.floor((Date.now() / 1000) - mintDate);
				if (health >= minHealth && totalClaims >= minKeyClaims && age >= minKeyAge) {
					key.classList.add("key");
					key.onclick = () => selectKey(tokenId);
				} else {
					key.classList.add("key-disabled");
					key.onclick = () => selectKey(tokenId);
				}
				key.innerHTML = `
					<div class="key-image"></div>
					<div class="key-details">
						<div>Health: ${health}</div>
						<div>Mint Date: ${new Date(mintDate * 1000).toLocaleString()}</div>
						<div>Total Claims: ${totalClaims}</div>
						<div>Claimed in Period: ${hasClaimedInPeriod ? "Yes" : "No"}</div>
					</div>
				`;
				container.appendChild(key);
			}
		}
        // Update the board with the latest game state from the contract. Need to actually reverse order if user is player B.
        async function updateBoard() {
            let board = await mancalaContract.methods.getBoard(gameId).call();
            let gameState = await mancalaContract.methods.getGameState(gameId).call();
            currentPlayer = await mancalaContract.methods.getCurrentPlayer(gameId).call();
            players = await mancalaContract.methods.getPlayers(gameId).call();
            for (let i = 0; i < 6; i++) {
                document.getElementById(`pit${i}`).innerText = board[i];
                document.getElementById(`pit${i + 7}`).innerText = board[i + 7];
            }

            document.getElementById("storeA").innerText = board[6];
            document.getElementById("storeB").innerText = board[13];

            // Enable or disable pits based on the current player
            let accounts = await web3.eth.getAccounts();
            let player = accounts[0];

            // Disable Player A's pits if it's Player B's turn
            for (let i = 0; i < 6; i++) {
                let pitA = document.getElementById(`pit${i}`);
                let pitB = document.getElementById(`pit${i + 7}`);

                if (currentPlayer.toLowerCase() === players[0].toLowerCase()) {
                    pitA.classList.remove('disabled');
                    pitB.classList.add('disabled');
                    pitB.onclick = null; // Disable Player B's pits
                    pitA.onclick = () => makeMove(i); // Enable Player A's pits
                } else {
                    pitA.classList.add('disabled');
                    pitA.onclick = null; // Disable Player A's pits
                    pitB.classList.remove('disabled');
                    pitB.onclick = () => makeMove(i + 7); // Enable Player B's pits
                }
            }
        }

        window.onload = initialize;
    </script>
</body>
</html>
