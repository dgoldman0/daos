<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mancala - Organic Themed</title>
	<!-- Google Fonts for better typography -->
	<link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
	<!-- Include Font Awesome for icons -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #faf3e0;
            color: #333;
            margin: 0;
            padding: 0;
            text-align: center;
        }

        h1 {
            margin-top: 20px;
            color: #8b5e34;
            font-size: 2.5em;
        }

		header {
			background-color: #8b5e34; /* Matches the color scheme of the desert theme */
			padding: 20px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			color: #f7f3e9; /* Lighter, earthy tones for text */
			border-bottom: 2px solid #e0d8c3; /* Subtle border to match page */
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); /* Softer shadow to blend with the organic theme */
		}

		header h1 {
			font-size: 22px;
			text-transform: uppercase;
			color: #f7f3e9; /* Matches lighter text tone */
			letter-spacing: 0.1em;
			text-shadow: 0 0 5px #b08a63; /* Softer glow with desert tones */
		}

		.connect-wallet {
			padding: 12px 25px;
			background-color: #e0d8c3; /* Matches the background color of the page */
			color: #8b5e34; /* Uses the same brown from the header */
			border: none;
			border-radius: 5px;
			cursor: pointer;
			font-weight: 500;
			transition: background-color 0.3s, box-shadow 0.3s;
			text-transform: uppercase;
			font-size: 14px;
			letter-spacing: 0.1em;
			box-shadow: 0 0 15px rgba(139, 94, 52, 0.5); /* Softer shadow with earth tones */
		}

		.connect-wallet:hover {
			background-color: #b08a63; /* Darker brown on hover for contrast */
			color: #f7f3e9; /* Light text on hover */
			box-shadow: 0 0 20px rgba(139, 94, 52, 0.7), 0 0 40px rgba(139, 94, 52, 0.7); /* Enhanced shadow effect on hover */
		}

        .game-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin: 50px auto;
            width: 90%;
        }

        .key-container {
            background-color: #e0d8c3;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            margin-right: 20px;
            flex: 1;
            max-width: 300px;
            overflow-y: auto;
            height: 100%;
        }

		.key-scrollable {
			overflow-y: auto;
			max-height: 500px;
		}

        .key {
            background-color: #f7f3e9;
            border: 2px solid #8b5e34;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            text-align: left;
            color: #52382b;
            font-weight: bold;
        }

        .key:hover {
            background-color: #b08a63;
            color: #fff;
        }

		.key-disabled {
			background-color: #ccc;
			color: #999;
			cursor: not-allowed;
            border: 2px solid #8b5e34;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            color: #55585C;
            font-weight: bold;
		}
		.match-area {
			display: flex;
			flex: 2;
			justify-content: center;
			align-items: center;
			background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
			background-color: #e0d8c3;
			padding: 40px;
			border-radius: 20px;
			box-shadow: 0 0 30px rgba(0, 0, 0, 0.2);
		}
		.match-menu {
			justify-content: flex-start;
			background-color: #e0d8c3;
			padding: 20px;
			border-radius: 10px;
			box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
			margin-right: 20px;
			margin-bottom: 100px;
			flex: 1;
			overflow-y: auto;
			height: 100%;
			display: flex;
			flex-direction: row;
			overflow-x: auto;
		}
		.match-label {
			font-size: 1.2em;
			color: #8b5e34;
			font-weight: bold;
		}
		.match {
			background-color: #e0d8c3;
			padding: 20px;
			border-radius: 10px;
			box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
			margin-right: 20px;
			flex: 1;
			max-width: 300px;
			overflow-y: auto;
			height: 100%;
		}

        .board-container {
            flex: 2;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            background-color: #e0d8c3;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.2);
        }

        .board {
            display: grid;
            grid-template-columns: repeat(8, 110px);
            grid-gap: 50px;
        }

        .pit, .store {
            width: 110px;
            height: 110px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f7f3e9;
            border: 3px solid #8b5e34;
            border-radius: 50%;
            font-size: 1.8em;
            color: #52382b;
            font-weight: bold;
            position: relative;
        }

        .store {
            grid-row: span 2;
            background-color: #8b5e34;
            color: #f7f3e9;
            border-radius: 100px;
            width: 130px;
            height: 230px;
        }

        .pit:hover {
            background-color: #b08a63;
            color: #fff;
            cursor: pointer;
        }

        .disabled {
            background-color: #ccc;
            color: #999;
            cursor: not-allowed;
        }

		.opponent {
			background-color: #6b4f2b;
			color: #999;
			cursor: not-allowed;
		}

        .store-title {
            position: absolute;
            top: -80px;
            font-size: 0.8em;
            color: #333;
        }

        #message {
            font-size: 1.5em;
            margin-top: 20px;
            color: #6b4f2b;
        }

        footer {
            margin-top: 50px;
            font-size: 0.8em;
            color: #7b5d46;
        }
		.modal {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background-color: #e0d8c3;
			border: 2px solid #8b5e34;
			border-radius: 10px;
			box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
			padding: 20px;
			text-align: center;
			z-index: 1000;
		}
		.modal-content {
			margin: 10px 0;
		}

		.modal button {
			margin: 5px;
			padding: 10px 20px;
			background-color: #8b5e34;
			color: #fff;
			border: none;
			border-radius: 5px;
			cursor: pointer;
		}

		.modal button:hover {
			background-color: #b08a63;
		}
		
		.match-scrollable {
			overflow-y: auto;
			max-height: 100px;
		}

		.match-request-block {
			justify-content: flex-start;
			background-color: #f7f3e9;
			border: 2px solid #8b5e34;
			border-radius: 8px;
			padding: 10px;
			margin-bottom: 10px;
			cursor: pointer;
			text-align: left;
			color: #52382b;
			font-weight: bold;
		}
		.top-menu {
			display: flex;
			justify-content: flex-start;
			align-items: center;
			padding: 10px 20px;
			background-color: #8b5e34;
			color: #f7f3e9;
		}
		.menu-item {
			color: #f7f3e9;
			text-decoration: none;
			font-weight: bold;
			padding: 10px 20px;
		}
    </style>
</head>
<body>
	<header>
		<h1><i class="fa-solid fa-chess-board"></i> Mancala - Desert Wisdom</h1>
		<button id="connectWalletButton" class="connect-wallet">Connect Wallet</button>
	  </header>
		<div class="top-menu">
		<a class = "menu-item" href="/">Home</a>
		<a class = "menu-item"  href="/lotto">Lotto</a>
	</div>

    <div class="game-container">
        <div class="key-container">
            <h2>Available Keys</h2>
			<input type="checkbox" id="hideInvalidKeys" onchange="updateKeys()"> Hide Invalid Keys<br>
			<div id="keyContainer" class = "key-scrollable"></div>
        </div>

		<div class="game-area">
			<!-- List of ongoing matches-->
			<div id="ongoingMatches" class = "match-menu">
			</div>
			<div class="board-container" id = "board-area">
				<div class="board" id="mancalaBoard">
					<!-- Player B's pits and store -->
					<div class="store" id="storeB">
						<div class="store-title">Opponent Store</div>
						<span id="storeBSeeds">0</span>
					</div>
					<div class="pit opponent" id="pit12">X</div>
					<div class="pit opponent" id="pit11">X</div>
					<div class="pit opponent" id="pit10">X</div>
					<div class="pit opponent" id="pit9">X</div>
					<div class="pit opponent" id="pit8">X</div>
					<div class="pit opponent" id="pit7">X</div>

					<!-- Empty placeholder for symmetry -->
					<div></div>

					<!-- Player A's pits and store -->
					<div class="pit" id="pit0" onclick="makeMove(0)">X</div>
					<div class="pit" id="pit1" onclick="makeMove(1)">X</div>
					<div class="pit" id="pit2" onclick="makeMove(2)">X</div>
					<div class="pit" id="pit3" onclick="makeMove(3)">X</div>
					<div class="pit" id="pit4" onclick="makeMove(4)">X</div>
					<div class="pit" id="pit5" onclick="makeMove(5)">X</div>
					<div class="store" id="storeA">
						<div class="store-title">Your Store</div>
						<span id="storeASeeds">0</span>
					</div>
				</div>
			</div>
		</div>
    </div>
	<div id="keyActionModal" class="modal" style="display: none;">
		<div class="modal-content">
			<h3>Select Action</h3>
			<p>Do you want to start a new match or accept an existing one?</p>
			<button onclick="chooseAction('new')">Start New Match</button>
			<button onclick="chooseAction('existing')">Accept Existing Match</button>
			<button onclick="closeMainModal(true)">Cancel</button>
		</div>
	</div>
	<!-- Modal for selecting a match request-->
	<div id="matchRequestModal" class="modal" style="display: none;">
		<div class="modal-content">
			<h3>Match Request</h3>
			<div id="matchRequestList" class = "match-scrollable"></div>
			<button onclick="closeMatchRequestModal(true)">Cancel</button>
		</div>
	</div>
    <div id="message">Choose match or start new one...</div>

    <footer>
        &copy; 2024 Mancala by the Sands | Arcadium
    </footer>

    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.5.2/dist/web3.min.js"></script>
    <script>
        let mancalaContractAddress = "0x967548CE5b86552A2dEcD1F17f7273927506D2B5";
		let keyContractAddress = "0xe75c2251478A2DA595B29e417d813B042D5d83aC";
		let keyDataManagerContractAddress = "0x6Ed1c7185da8B225c292d9d4c7ad675637a5C0b4";

        const mancalaABI = [
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_keyContract",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "_keyDataContract",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "_minKeyHealth",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "_minKeyAge",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "_minKeyClaims",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "_returnKeys",
						"type": "bool"
					},
					{
						"internalType": "address payable",
						"name": "_mancalaMatchNFT",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "_potToken",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "_potFee",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "_returnPotIfRejected",
						"type": "bool"
					},
					{
						"internalType": "uint256",
						"name": "_roundTimeCap",
						"type": "uint256"
					}
				],
				"stateMutability": "nonpayable",
				"type": "constructor"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					},
					{
						"indexed": false,
						"internalType": "address",
						"name": "winner",
						"type": "address"
					},
					{
						"indexed": false,
						"internalType": "address",
						"name": "token",
						"type": "address"
					},
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "balance",
						"type": "uint256"
					}
				],
				"name": "GameEnded",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					},
					{
						"indexed": false,
						"internalType": "address",
						"name": "playerA",
						"type": "address"
					},
					{
						"indexed": false,
						"internalType": "address",
						"name": "playerB",
						"type": "address"
					}
				],
				"name": "GameStarted",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					},
					{
						"indexed": false,
						"internalType": "address",
						"name": "playerA",
						"type": "address"
					},
					{
						"indexed": false,
						"internalType": "address",
						"name": "playerB",
						"type": "address"
					}
				],
				"name": "MatchRequested",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					},
					{
						"indexed": false,
						"internalType": "address",
						"name": "player",
						"type": "address"
					},
					{
						"indexed": false,
						"internalType": "uint8",
						"name": "pitIndex",
						"type": "uint8"
					}
				],
				"name": "MoveMade",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "cancelledBy",
						"type": "address"
					}
				],
				"name": "NominationCancelled",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "OwnerNominated",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "previousOwner",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "OwnershipTransferred",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					},
					{
						"indexed": false,
						"internalType": "address",
						"name": "currentPlayer",
						"type": "address"
					}
				],
				"name": "TurnChanged",
				"type": "event"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "keyId",
						"type": "uint256"
					}
				],
				"name": "acceptMatch",
				"outputs": [],
				"stateMutability": "payable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "acceptOwnership",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					}
				],
				"name": "cancelMatch",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "cancelTransfer",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "changeOwner",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "gameIdCounter",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"name": "games",
				"outputs": [
					{
						"internalType": "address",
						"name": "playerA",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "playerB",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "currentPlayer",
						"type": "address"
					},
					{
						"internalType": "enum MancalaGame.GameState",
						"name": "state",
						"type": "uint8"
					},
					{
						"internalType": "uint256",
						"name": "requestTime",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "startTime",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "keyA",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "keyB",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "potToken",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "potFee",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "roundStartTime",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					}
				],
				"name": "getBoard",
				"outputs": [
					{
						"internalType": "uint8[14]",
						"name": "",
						"type": "uint8[14]"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					}
				],
				"name": "getCurrentPlayer",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					}
				],
				"name": "getGameState",
				"outputs": [
					{
						"internalType": "enum MancalaGame.GameState",
						"name": "",
						"type": "uint8"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					}
				],
				"name": "getPlayers",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "keyContract",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "keyDataContract",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "mancalaMatchNFT",
				"outputs": [
					{
						"internalType": "address payable",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "minKeyAge",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "minKeyClaims",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "minKeyHealth",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					},
					{
						"internalType": "uint8",
						"name": "pitIndex",
						"type": "uint8"
					}
				],
				"name": "moveSeeds",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "nominationDate",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "owner",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "ownerNominee",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "potFee",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "potToken",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "gameId",
						"type": "uint256"
					}
				],
				"name": "rejectMatch",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "rejectOwnership",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "opponent",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "keyId",
						"type": "uint256"
					}
				],
				"name": "requestMatch",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "payable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "requestTimeout",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "returnKeys",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "returnPotIfRejected",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "roundTimeCap",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_keyContract",
						"type": "address"
					}
				],
				"name": "setKeyContract",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_keyDataContract",
						"type": "address"
					}
				],
				"name": "setKeyDataContract",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address payable",
						"name": "_mancalaMatchNFT",
						"type": "address"
					}
				],
				"name": "setMancalaMatchNFT",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_minKeyAge",
						"type": "uint256"
					}
				],
				"name": "setMinKeyAge",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_minKeyClaims",
						"type": "uint256"
					}
				],
				"name": "setMinKeyClaims",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_minKeyHealth",
						"type": "uint256"
					}
				],
				"name": "setMinKeyHealth",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_potFee",
						"type": "uint256"
					}
				],
				"name": "setPotFee",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_potToken",
						"type": "address"
					}
				],
				"name": "setPotToken",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "bool",
						"name": "_returnKeys",
						"type": "bool"
					}
				],
				"name": "setReturnKeys",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "bool",
						"name": "_returnPotIfRejected",
						"type": "bool"
					}
				],
				"name": "setReturnPotIfRejected",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_roundTimeCap",
						"type": "uint256"
					}
				],
				"name": "setRoundTimeCap",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "spareGameId",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_token",
						"type": "address"
					}
				],
				"name": "withdraw",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"stateMutability": "payable",
				"type": "receive"
			}
		];	

		const keyABI = [
			{
				"inputs": [],
				"stateMutability": "nonpayable",
				"type": "constructor"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "owner",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "address",
						"name": "approved",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "Approval",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "owner",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "address",
						"name": "operator",
						"type": "address"
					},
					{
						"indexed": false,
						"internalType": "bool",
						"name": "approved",
						"type": "bool"
					}
				],
				"name": "ApprovalForAll",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "minter",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "NFTMinted",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "cancelledBy",
						"type": "address"
					}
				],
				"name": "NominationCancelled",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "OwnerNominated",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "previousOwner",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "OwnershipTransferred",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "from",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "address",
						"name": "to",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "Transfer",
				"type": "event"
			},
			{
				"inputs": [],
				"name": "acceptOwnership",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "to",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "approve",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "owner",
						"type": "address"
					}
				],
				"name": "balanceOf",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "cancelTransfer",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "changeOwner",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "claimManager",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "firstMintDate",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "fundReceiver",
				"outputs": [
					{
						"internalType": "address payable",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "getApproved",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "owner",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "operator",
						"type": "address"
					}
				],
				"name": "isApprovedForAll",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "maxSupply",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_count",
						"type": "uint256"
					}
				],
				"name": "mint",
				"outputs": [],
				"stateMutability": "payable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "mintPrice",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_to",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "_count",
						"type": "uint256"
					}
				],
				"name": "mintTo",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "name",
				"outputs": [
					{
						"internalType": "string",
						"name": "",
						"type": "string"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "nextTokenId",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "nominationDate",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "owner",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "ownerNominee",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "ownerOf",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "paymentToken",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "rejectOwnership",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "from",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "to",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "safeTransferFrom",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "from",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "to",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					},
					{
						"internalType": "bytes",
						"name": "data",
						"type": "bytes"
					}
				],
				"name": "safeTransferFrom",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "operator",
						"type": "address"
					},
					{
						"internalType": "bool",
						"name": "approved",
						"type": "bool"
					}
				],
				"name": "setApprovalForAll",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "string",
						"name": "baseTokenURI",
						"type": "string"
					}
				],
				"name": "setBaseTokenURI",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_claimManager",
						"type": "address"
					}
				],
				"name": "setClaimManager",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address payable",
						"name": "_fundReceiver",
						"type": "address"
					}
				],
				"name": "setFundReceiver",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_maxSupply",
						"type": "uint256"
					}
				],
				"name": "setMaxSupply",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_paymentToken",
						"type": "address"
					}
				],
				"name": "setPaymentToken",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_price",
						"type": "uint256"
					}
				],
				"name": "setPrice",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "bytes4",
						"name": "interfaceId",
						"type": "bytes4"
					}
				],
				"name": "supportsInterface",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "symbol",
				"outputs": [
					{
						"internalType": "string",
						"name": "",
						"type": "string"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "index",
						"type": "uint256"
					}
				],
				"name": "tokenByIndex",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "owner",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "index",
						"type": "uint256"
					}
				],
				"name": "tokenOfOwnerByIndex",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "tokenURI",
				"outputs": [
					{
						"internalType": "string",
						"name": "",
						"type": "string"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "totalSupply",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "from",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "to",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "transferFrom",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_token",
						"type": "address"
					}
				],
				"name": "withdraw",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"stateMutability": "payable",
				"type": "receive"
			}
		];

		const keyDataManagerABI = [
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_nftContract",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "_potionToken",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "_paymentManager",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "_claimerLimit",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "_claimPeriod",
						"type": "uint256"
					},
					{
						"internalType": "uint8",
						"name": "_min_health",
						"type": "uint8"
					}
				],
				"stateMutability": "nonpayable",
				"type": "constructor"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "claimant",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "Claim",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "cancelledBy",
						"type": "address"
					}
				],
				"name": "NominationCancelled",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "OwnerNominated",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "previousOwner",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "OwnershipTransferred",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "owner",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					},
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "qnt",
						"type": "uint256"
					}
				],
				"name": "TokenRepaired",
				"type": "event"
			},
			{
				"inputs": [],
				"name": "acceptOwnership",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "cancelTransfer",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "newOwner",
						"type": "address"
					}
				],
				"name": "changeOwner",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "claim",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "claimPeriod",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "index",
						"type": "uint256"
					}
				],
				"name": "claimant",
				"outputs": [
					{
						"components": [
							{
								"internalType": "address",
								"name": "addr",
								"type": "address"
							},
							{
								"internalType": "uint256",
								"name": "tokenId",
								"type": "uint256"
							}
						],
						"internalType": "struct ClaimNFTManager.Claimant",
						"name": "",
						"type": "tuple"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"name": "claimants",
				"outputs": [
					{
						"internalType": "address",
						"name": "addr",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "claimerLimit",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"name": "controllers",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "deleteClaimants",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "getClaimants",
				"outputs": [
					{
						"components": [
							{
								"internalType": "address",
								"name": "addr",
								"type": "address"
							},
							{
								"internalType": "uint256",
								"name": "tokenId",
								"type": "uint256"
							}
						],
						"internalType": "struct ClaimNFTManager.Claimant[]",
						"name": "",
						"type": "tuple[]"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "getClaimantsCount",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "getHealth",
				"outputs": [
					{
						"internalType": "uint8",
						"name": "",
						"type": "uint8"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "getMintDate",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "getTotalClaims",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "hasClaimedInPeriod",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "initializeNFT",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "isClaimReady",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "min_health",
				"outputs": [
					{
						"internalType": "uint8",
						"name": "",
						"type": "uint8"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "nftContract",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "nominationDate",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "owner",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "ownerNominee",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "paymentManager",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "potionToken",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "rejectOwnership",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					},
					{
						"internalType": "uint8",
						"name": "_qnt",
						"type": "uint8"
					}
				],
				"name": "repair",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "tokenId",
						"type": "uint256"
					}
				],
				"name": "resetClaim",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_claimPeriod",
						"type": "uint256"
					}
				],
				"name": "setClaimPeriod",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_claimerLimit",
						"type": "uint256"
					}
				],
				"name": "setClaimerLimit",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "uint8",
						"name": "_min_health",
						"type": "uint8"
					}
				],
				"name": "setMinHealth",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_nftContract",
						"type": "address"
					}
				],
				"name": "setNFTContract",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_paymentManager",
						"type": "address"
					}
				],
				"name": "setPaymentManager",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_potionToken",
						"type": "address"
					}
				],
				"name": "setPotionToken",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "_token",
						"type": "address"
					}
				],
				"name": "withdraw",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"stateMutability": "payable",
				"type": "receive"
			}
		];

		const erc20ABI = [
			{
				"inputs": [],
				"stateMutability": "nonpayable",
				"type": "constructor"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "owner",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "address",
						"name": "spender",
						"type": "address"
					},
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "value",
						"type": "uint256"
					}
				],
				"name": "Approval",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"internalType": "address",
						"name": "from",
						"type": "address"
					},
					{
						"indexed": true,
						"internalType": "address",
						"name": "to",
						"type": "address"
					},
					{
						"indexed": false,
						"internalType": "uint256",
						"name": "value",
						"type": "uint256"
					}
				],
				"name": "Transfer",
				"type": "event"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "owner",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "spender",
						"type": "address"
					}
				],
				"name": "allowance",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "spender",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "amount",
						"type": "uint256"
					}
				],
				"name": "approve",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "account",
						"type": "address"
					}
				],
				"name": "balanceOf",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "decimals",
				"outputs": [
					{
						"internalType": "uint8",
						"name": "",
						"type": "uint8"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "spender",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "subtractedValue",
						"type": "uint256"
					}
				],
				"name": "decreaseAllowance",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "spender",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "addedValue",
						"type": "uint256"
					}
				],
				"name": "increaseAllowance",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "name",
				"outputs": [
					{
						"internalType": "string",
						"name": "",
						"type": "string"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "symbol",
				"outputs": [
					{
						"internalType": "string",
						"name": "",
						"type": "string"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "totalSupply",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "to",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "amount",
						"type": "uint256"
					}
				],
				"name": "transfer",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "from",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "to",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "amount",
						"type": "uint256"
					}
				],
				"name": "transferFrom",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "nonpayable",
				"type": "function"
			}
		];

		let web3;
        let mancalaContract;
		let keyContract;
		let keyDataManagerContract;
        let gameId;
        let currentPlayer;
        let players;

		let selectedKeyId = null;

		const connectWalletButton = document.getElementById('connectWalletButton');
			connectWalletButton.addEventListener('click', async () => {
			await connectWallet();
			});
			
			async function connectWallet() {
				if (window.ethereum) {
					try {
						await window.ethereum.request({ method: 'eth_requestAccounts' });
						web3 = new Web3(window.ethereum);
						const accounts = await web3.eth.getAccounts();
						userAddress = accounts[0];
						connectWalletButton.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
						await initialize(); // Reset
					} catch (error) {
					console.error('User denied account access');
					}
				} else {
					alert('Please install MetaMask!');
				}
			}

			async function selectKey(keyId) {
			let accounts = await web3.eth.getAccounts();
			selectedKeyId = keyId;
			// Check if key is approved to be
			let approved = await keyContract.methods.getApproved(keyId).call();
			if (approved !== mancalaContractAddress) {
				await keyContract.methods.approve(mancalaContractAddress, keyId).send({ from: accounts[0] });
			}
			document.getElementById("keyActionModal").style.display = "block";
		}
		
		function closeMainModal(clear = false) {
			document.getElementById("keyActionModal").style.display = "none";
			if (clear)
				selectedKeyId = null;
		}

		function closeMatchRequestModal(clear = false) {
			document.getElementById("matchRequestModal").style.display = "none";
			selectedKeyId = null;
		}

		function chooseAction(action) {
			if (action === 'new') {
				let opponent = prompt("Enter the opponent's address:");
				if (opponent) {
					startNewMatch(selectedKeyId, opponent);
				} else {
					alert("You must enter an opponent's address to start a new match.");
				}
				closeMainModal();
			} else if (action === 'existing') {
				listMatchRequests(selectedKeyId);
				closeMainModal();
				// Open the match request modal
				document.getElementById("matchRequestModal").style.display = "block";
			}
		}

		async function startNewMatch(tokenId, opponent) {
			let accounts = await web3.eth.getAccounts();

			// Check if there's a pot fee, and what pot token if any. 
			const potFee = BigInt(await mancalaContract.methods.potFee().call());
			if (potFee > 0) {
				const potToken = await mancalaContract.methods.potToken().call();
				// If token is 0x0, it's ETH otherwise it's an ERC20 token
				if (potToken === "0x0000000000000000000000000000000000000000") {
					// Check if the user has enough ETH
					const balance = BigInt(await web3.eth.getBalance(accounts[0]));
					if (balance < potFee) {
						alert("You don't have enough ETH to start a match.");
						return;
					}
				} else {
					// Check if the user has enough of the pot token and if sufficient allowance is given
					const potTokenContract = new web3.eth.Contract(erc20ABI, potToken);
					const balance = BigInt(await potTokenContract.methods.balanceOf(accounts[0]).call());
					if (balance < potFee) {
						alert("You don't have enough of the pot token to start a match.");
						return;
					}
					const allowance = await potTokenContract.methods.allowance(accounts[0], mancalaContractAddress).call();
					try {
						if (allowance < potFee) {
							await potTokenContract.methods.approve(mancalaContractAddress, potFee).send({ from: accounts[0] });
						}
					} catch (error) {
						alert("You must approve the pot token to start a match.");
						return;
					}
				}

			}
            gameId = await mancalaContract.methods.requestMatch(opponent, tokenId).send({ from: accounts[0] });  
			// Convert to integer
			gameId = parseInt(gameId.events.MatchRequested.returnValues.gameId);
            localStorage.setItem("gameId", gameId);

		}

		// List matches by scanning events for MatchRequested events with the user's address as playerB
		async function listMatchRequests() {
			let accounts = await web3.eth.getAccounts();
			// Same but with pagination
			let pageSize = 10;
			// Use gameIdCounter to get the number of games, then scan through from newest to oldest, selecting those where playerB matches and where game is pending
			let gameIdCounter = await mancalaContract.methods.gameIdCounter().call();
			let requests = [];
			let i = gameIdCounter;
			while (requests.length < pageSize && i > 0) {
				// Use the mancala contract to get the game state
				let gameState = await mancalaContract.methods.getGameState(i).call();
				if (gameState === "0") {
					players = await mancalaContract.methods.getPlayers(i).call();
					console.log(players[0]);
					if (players[1] === accounts[0]) {
						requests.push({
							gameId: i,
							playerA: players[0]
						});
					}

				}
				i--;
			}			
			let container = document.getElementById("matchRequestList");
			container.innerHTML = "";
			for (let i = 0; i < requests.length; i++) {
				let request = requests[i];
				let match = document.createElement("div");
				match.classList.add("match-request");
				match.innerHTML = `
					<div class = "match-request-block">
					<div class = "match-request-label">Match request from ${request.playerA}</div>
					<center><button class = "match-request-button" onclick="acceptMatch('${request.gameId}')">Accept</button></center>
					</div>
				`;
				container.appendChild(match);
			}
			
		}

		async function initialize() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                await window.ethereum.request({ method: "eth_requestAccounts" });
                let accounts = await web3.eth.getAccounts();
				let userAddress = accounts[0];
                mancalaContract = new web3.eth.Contract(mancalaABI, mancalaContractAddress);
				keyContract = new web3.eth.Contract(keyABI, keyContractAddress);
				keyDataManagerContract = new web3.eth.Contract(keyDataManagerABI, keyDataManagerContractAddress);
		          connectWalletButton.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;

				await updateMatches();
				await updateKeys();

                // Listen to events
                mancalaContract.events.MoveMade({}).on("data", event => {
                    updateBoard();
                });

                mancalaContract.events.GameEnded({}).on("data", event => {
                    let winner = event.returnValues.winner;
                    document.getElementById("message").innerText = (winner === "0x0000000000000000000000000000000000000000") ? 
                        "It's a draw!" : `Winner is ${winner}`;
                });
            } else {
                alert("Please install MetaMask to play this game!");
            }
        }

		async function updateMatches() {
			let accounts = await web3.eth.getAccounts();
			// Get the current game count and then get a list of ongoing games involving the user
			let gameIdCounter = await mancalaContract.methods.gameIdCounter().call();
			let ongoingGames = [];
			let pendingGames = [];
			for (let i = 1; i <= gameIdCounter; i++) {
				let gameState = await mancalaContract.methods.getGameState(i).call();
				let players = await mancalaContract.methods.getPlayers(i).call();
				if (players[0] === accounts[0] || players[1] === accounts[0]) {
					if (gameState === "1") {
						ongoingGames.push(i);
 					} else {
						pendingGames.push(i);
					}
				}
			}
			// If there are ongoing games, select the first one
			if (ongoingGames.length > 0 && !localStorage.getItem("gameId")) {
				gameId = ongoingGames[0];
				localStorage.setItem("gameId", gameId);
			}	
			// Update the ongoing matches div
			let container = document.getElementById("ongoingMatches");
			container.innerHTML = "";
			for (let i = 0; i < ongoingGames.length; i++) {
				let match = document.createElement("div");
				// Add onclick
				match.onclick = () => loadMatch(ongoingGames[i]);
				match.classList.add("match");
				match.innerHTML = `
					<div class="match-label">Match ${ongoingGames[i]}</div>
				`;
				container.appendChild(match);
			}

		}

		// Load match
		async function loadMatch(_gameId) {
			gameId = _gameId;
			localStorage.setItem("gameId", _gameId);
			document.getElementById("message").innerText = "Match loaded!";
			updateBoard();
		}

		// Accept a match request
		async function acceptMatch(gameId) {
			let accounts = await web3.eth.getAccounts();

			// Check if there's a pot fee, and what pot token if any.
			const potFee = BigInt((await mancalaContract.methods.games(gameId).call()).potFee);
			if (potFee > 0) {
				const potToken = (await mancalaContract.methods.games(gameId).call()).potToken;
				// If token is 0x0, it's ETH otherwise it's an ERC20 token
				if (potToken === "0x0000000000000000000000000000000000000000") {
					// Check if the user has enough ETH
					const balance = BigInt(await web3.eth.getBalance(accounts[0]));
					if (balance < potFee) {
						alert("You don't have enough ETH to start a match.");
						return;
					}
				} else {
					// Check if the user has enough of the pot token and if sufficient allowance is given
					const potTokenContract = new web3.eth.Contract(erc20ABI, potToken);
					const balance = BigInt(await potTokenContract.methods.balanceOf(accounts[0]).call());
					if (balance < potFee) {
						alert("You don't have enough of the pot token to start a match.");
						return;
					}
					const allowance = await potTokenContract.methods.allowance(accounts[0], mancalaContractAddress).call();
					try {
						if (allowance < potFee) {
							await potTokenContract.methods.approve(mancalaContractAddress, potFee).send({ from: accounts[0] });
						}
					} catch (error) {
						alert("You must approve the pot token to start a match.");
						return;
					}
				}
			}

			await mancalaContract.methods.acceptMatch(gameId, selectedKeyId).send({ from: accounts[0] });
			console.log("Match accepted!");
			localStorage.setItem("gameId", gameId);
			closeMatchRequestModal();
			console.log("Closed");
			updateBoard();
		}

        // Make a move by calling the contract's function
        async function makeMove(pitIndex) {
			console.log(pitIndex);
            let accounts = await web3.eth.getAccounts();
            let player = accounts[0];

            // Only allow current player to make a move
            if (player.toLowerCase() !== currentPlayer.toLowerCase()) {
                document.getElementById("message").innerText = "It's not your turn!";
                return;
            }

            try {
                await mancalaContract.methods.moveSeeds(gameId, pitIndex).send({ from: player });
				updateBoard();
                document.getElementById("message").innerText = "Move made! Waiting for the next move...";
            } catch (err) {
                console.error(err);
                document.getElementById("message").innerText = "Error making move!";
            }
        }

		// Load NFT keys
		async function updateKeys() {
			// Get the requirements for keys from the mancala contract
			const minHealth = await mancalaContract.methods.minKeyHealth().call();
			const minKeyAge = await mancalaContract.methods.minKeyAge().call();
			const minKeyClaims = await mancalaContract.methods.minKeyClaims().call();

			const accounts = await web3.eth.getAccounts();
			const balance = await keyContract.methods.balanceOf(accounts[0]).call();

			const hideInvalidKeys = document.getElementById("hideInvalidKeys").checked;

			let keys = [];

			let container = document.getElementById("keyContainer");
			container.innerHTML = "";

			for (let i = 0; i < balance; i++) {
				const tokenId = await keyContract.methods.tokenOfOwnerByIndex(accounts[0], i).call();
				// Use the NFT data manager contract to get key details.
				const health = await keyDataManagerContract.methods.getHealth(tokenId).call();
				const mintDate = await keyDataManagerContract.methods.getMintDate(tokenId).call();
				const totalClaims = await keyDataManagerContract.methods.getTotalClaims(tokenId).call();
				const hasClaimedInPeriod = await keyDataManagerContract.methods.hasClaimedInPeriod(tokenId).call();
				// Create key element and add
				let key = document.createElement("div");
				// If the key meets the requirements, add the key class, otherwise key-disabled
				let age = Math.floor((Date.now() / 1000) - mintDate);
				if (health >= minHealth && totalClaims >= minKeyClaims && age >= minKeyAge) {
					key.classList.add("key");
					key.onclick = () => selectKey(tokenId);
				} else {
					if (hideInvalidKeys) continue;
					key.classList.add("key-disabled");
					key.onclick = () => selectKey(tokenId);
				}
				key.innerHTML = `
					<div class="key-image"></div>
					<div class="key-details">
						<div>Health: ${health}</div>
						<div>Mint Date: ${new Date(mintDate * 1000).toLocaleString()}</div>
						<div>Total Claims: ${totalClaims}</div>
						<div>Claimed in Period: ${hasClaimedInPeriod ? "Yes" : "No"}</div>
					</div>
				`;
				container.appendChild(key);
			}
		}
        // Update the board with the latest game state from the contract. Need to actually reverse order if user is player B.
		// Need to do a board flip depending on who is player A and who is player B. And I lose my labels...
        async function updateBoard() {
			if (gameId === undefined) return;
			let accounts = await web3.eth.getAccounts();
            let player = accounts[0];
			
            let gameState = await mancalaContract.methods.getGameState(gameId).call();
            let board = await mancalaContract.methods.getBoard(gameId).call();
            currentPlayer = await mancalaContract.methods.getCurrentPlayer(gameId).call();
            players = await mancalaContract.methods.getPlayers(gameId).call();

			const isPlayerA = players[0].toLowerCase() === accounts[0].toLowerCase();
			const isCurrentPlayer = currentPlayer.toLowerCase() === accounts[0].toLowerCase();

			let asPlayerA = `
				<div class="board" id="mancalaBoard">
					<!-- Player B's pits and store -->
					<div class="store" id="storeB">
						<div class="store-title">Opponent Store</div>
						<span id="storeBSeeds">0</span>
					</div>
					<div class="pit opponent" id="pit12">4</div>
					<div class="pit opponent" id="pit11">4</div>
					<div class="pit opponent" id="pit10">4</div>
					<div class="pit opponent" id="pit9">4</div>
					<div class="pit opponent" id="pit8">4</div>
					<div class="pit opponent" id="pit7">4</div>

					<!-- Empty placeholder for symmetry -->
					<div></div>

					<!-- Player A's pits and store -->
					<div class="pit" id="pit0" onclick="makeMove(0)">4</div>
					<div class="pit" id="pit1" onclick="makeMove(1)">4</div>
					<div class="pit" id="pit2" onclick="makeMove(2)">4</div>
					<div class="pit" id="pit3" onclick="makeMove(3)">4</div>
					<div class="pit" id="pit4" onclick="makeMove(4)">4</div>
					<div class="pit" id="pit5" onclick="makeMove(5)">4</div>
					<div class="store" id="storeA">
						<div class="store-title">Your Store</div>
						<span id="storeASeeds">0</span>
					</div>
				</div>
			`	

			// Flip board around if player B
			let asPlayerB = `
				<div class="board" id="mancalaBoard">
					<!-- Player A's pits and store -->
					<div class="store" id="storeA">
						<div class="store-title">Opponent Store</div>
						<span id="storeASeeds">0</span>
					</div>
					<div class="pit opponent" id="pit5">4</div>
					<div class="pit opponent" id="pit4">4</div>
					<div class="pit opponent" id="pit3">4</div>
					<div class="pit opponent" id="pit2">4</div>
					<div class="pit opponent" id="pit1">4</div>
					<div class="pit opponent" id="pit0">4</div>

					<!-- Empty placeholder for symmetry -->
					<div></div>

					<!-- Player B's pits and store -->
					<div class="pit" id="pit7" onclick="makeMove(7)">4</div>
					<div class="pit" id="pit8" onclick="makeMove(8)">4</div>
					<div class="pit" id="pit9" onclick="makeMove(9)">4</div>
					<div class="pit" id="pit10" onclick="makeMove(10)">4</div>
					<div class="pit" id="pit11" onclick="makeMove(11)">4</div>
					<div class="pit" id="pit12" onclick="makeMove(12)">4</div>
					<div class="store" id="storeB">
						<div class="store-title">Your Store</div>
						<span id="storeBSeeds">0</span>
					</div>
				</div>
			`;

			document.getElementById("board-area").innerHTML = (isPlayerA) ? asPlayerA : asPlayerB;
			for (let i = 0; i < 6; i++) {
                document.getElementById(`pit${i}`).innerText = board[i];
                document.getElementById(`pit${i + 7}`).innerText = board[i + 7];
            }

            document.getElementById("storeASeeds").innerText = board[6];
            document.getElementById("storeBSeeds").innerText = board[13];

            // Enable or disable pits based on the current player
            for (let i = 0; i < 6; i++) {
				let q = (isPlayerA) ? i : i + 7;
				if (isCurrentPlayer) {
					document.getElementById(`pit${q}`).classList.remove("disabled");
				} else {
					document.getElementById(`pit${q}`).classList.add("disabled");
				}
			}
	    }

        window.onload = initialize;
    </script>
</body>
</html>
